<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simple Emax model fit with Stan • rstanemax</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simple Emax model fit with Stan">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rstanemax</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/emaxmodel.html">Simple Emax model fit with Stan</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/yoshidk6/rstanemax/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Simple Emax model fit with Stan</h1>
                        <h4 data-toc-skip class="author">Kenta
Yoshida</h4>
            
            <h4 data-toc-skip class="date">2024-12-05</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/yoshidk6/rstanemax/blob/master/vignettes/emaxmodel.Rmd" class="external-link"><code>vignettes/emaxmodel.Rmd</code></a></small>
      <div class="d-none name"><code>emaxmodel.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/yoshidk6/rstanemax" class="external-link">rstanemax</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12345</span><span class="op">)</span></span></code></pre></div>
<p>This vignette provide an overview of the workflow of Emax model
analysis using this package.</p>
<div class="section level2">
<h2 id="typical-workflow">Typical workflow<a class="anchor" aria-label="anchor" href="#typical-workflow"></a>
</h2>
<div class="section level3">
<h3 id="model-run-with-stan_emax-function">Model run with <code>stan_emax</code> function<a class="anchor" aria-label="anchor" href="#model-run-with-stan_emax-function"></a>
</h3>
<p><code><a href="../reference/stan_emax.html">stan_emax()</a></code> is the main function of this package to
perform Emax model analysis on the data. This function requires minimum
two input arguments - <code>formula</code> and <code>data</code>. In the
<code>formula</code> argument, you will specify which columns of
<code>data</code> will be used as exposure and response data, in a
format similar to <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">stats::lm()</a></code> function,
e.g. <code>response ~ exposure</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">exposure.response.sample</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit.emax</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_emax.html">stan_emax</a></span><span class="op">(</span><span class="va">response</span> <span class="op">~</span> <span class="va">exposure</span>,</span>
<span>  data <span class="op">=</span> <span class="va">exposure.response.sample</span>,</span>
<span>  <span class="co"># the next line is only to make the example go fast enough</span></span>
<span>  chains <span class="op">=</span> <span class="fl">2</span>, iter <span class="op">=</span> <span class="fl">1000</span>, seed <span class="op">=</span> <span class="fl">12345</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.emax</span></span>
<span><span class="co">#&gt; ---- Emax model fit with rstanemax ----</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;        mean se_mean    sd  2.5%   25%   50%   75%  97.5%  n_eff Rhat</span></span>
<span><span class="co">#&gt; emax  92.25    0.36  6.00 80.19 88.36 92.39 96.14 103.66 280.65 1.00</span></span>
<span><span class="co">#&gt; e0     5.72    0.30  4.65 -2.89  2.63  5.47  8.51  15.49 248.72 1.00</span></span>
<span><span class="co">#&gt; ec50  75.46    0.85 19.88 45.00 61.41 72.92 87.02 118.99 545.68 1.01</span></span>
<span><span class="co">#&gt; gamma  1.00     NaN  0.00  1.00  1.00  1.00  1.00   1.00    NaN  NaN</span></span>
<span><span class="co">#&gt; sigma 16.60    0.07  1.63 13.79 15.47 16.52 17.60  20.03 585.62 1.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; * Use `extract_stanfit()` function to extract raw stanfit object</span></span>
<span><span class="co">#&gt; * Use `extract_param()` function to extract posterior draws of key parameters</span></span>
<span><span class="co">#&gt; * Use `plot()` function to visualize model fit</span></span>
<span><span class="co">#&gt; * Use `posterior_predict()` or `posterior_predict_quantile()` function to get</span></span>
<span><span class="co">#&gt;   raw predictions or make predictions on new data</span></span>
<span><span class="co">#&gt; * Use `extract_obs_mod_frame()` function to extract raw data </span></span>
<span><span class="co">#&gt;   in a processed format (useful for plotting)</span></span></code></pre></div>
<p><code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> function shows the estimated Emax model curve
with 95% credible intervals of parameters.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit.emax</span><span class="op">)</span></span></code></pre></div>
<p><img src="emaxmodel_files/figure-html/plot_example-1.png" width="700"></p>
<p>Output of <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> function (for <code>stanemax</code>
object) is a <code>ggplot</code> object, so you can apply additional
settings as you would do in <code>ggplot2</code>.<br>
Here is an example of using log scale for x axis (note that exposure ==
0 is hanging at the very left, making the curve a bit weird).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit.emax</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expand_limits.html" class="external-link">expand_limits</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in scale_x_log10(): <span style="color: #00BB00;">log-10</span> transformation introduced infinite values.</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">log-10</span> transformation introduced infinite values.</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">log-10</span> transformation introduced infinite values.</span></span></code></pre></div>
<p><img src="emaxmodel_files/figure-html/plot_example_log-1.png" width="700"></p>
<p>Raw output from <code>rstan</code> is stored in the output variable,
and you can access it with <code><a href="../reference/stanemax-methods.html">extract_stanfit()</a></code> function.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="fu"><a href="../reference/stanemax-methods.html">extract_stanfit</a></span><span class="op">(</span><span class="va">fit.emax</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "stanfit"</span></span>
<span><span class="co">#&gt; attr(,"package")</span></span>
<span><span class="co">#&gt; [1] "rstan"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="prediction-of-response-with-new-exposure-data">Prediction of response with new exposure data<a class="anchor" aria-label="anchor" href="#prediction-of-response-with-new-exposure-data"></a>
</h3>
<p><code><a href="../reference/posterior_predict.html">posterior_predict()</a></code> function allows users to predict the
response using new exposure data. If <code>newdata</code> is not
provided, the function returns the prediction on the exposures in
original data. The default output is a matrix of posterior predictions,
but you can also specify “dataframe” or “tibble” that contain posterior
predictions in a long format. See help of
<code><a href="../reference/posterior_predict.html">rstanemax::posterior_predict()</a></code> for the description of two
predictions, <code>respHat</code> and <code>response</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">response.pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posterior_predict.html">posterior_predict</a></span><span class="op">(</span><span class="va">fit.emax</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, <span class="fl">1000</span><span class="op">)</span>, returnType <span class="op">=</span> <span class="st">"tibble"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">response.pred</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">mcmcid</span>, <span class="va">exposure</span>, <span class="va">respHat</span>, <span class="va">response</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3,000 × 4</span></span></span>
<span><span class="co">#&gt;    mcmcid exposure   respHat response</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl[1d]&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>      1        0     11.8      14.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>      1      100     55.4      84.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>      1     <span style="text-decoration: underline;">1</span>000     88.0      80.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>      2        0     -<span style="color: #BB0000;">2.84</span>    -<span style="color: #BB0000;">17.0</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>      2      100     61.2      57.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>      2     <span style="text-decoration: underline;">1</span>000     90.8      83.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>      3        0      4.01    -<span style="color: #BB0000;">10.1</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>      3      100     57.5      57.6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>      3     <span style="text-decoration: underline;">1</span>000     92.1      85.6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>      4        0      6.34     42.3</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2,990 more rows</span></span></span></code></pre></div>
<p>You can also get quantiles of predictions with
<code><a href="../reference/posterior_predict.html">posterior_predict_quantile()</a></code> function.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resp.pred.quantile</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posterior_predict.html">posterior_predict_quantile</a></span><span class="op">(</span><span class="va">fit.emax</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5000</span>, by <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">resp.pred.quantile</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 51 × 11</span></span></span>
<span><span class="co">#&gt;    exposure covemax covec50 cove0 Covariates ci_low ci_med ci_high pi_low pi_med</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>        0 1       1       1     <span style="color: #949494;">""</span>          -<span style="color: #BB0000;">1.71</span>   5.47    13.9  -<span style="color: #BB0000;">22.3</span>   5.59</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>      100 1       1       1     <span style="color: #949494;">""</span>          52.8   58.9     64.8   30.0  58.4 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>      200 1       1       1     <span style="color: #949494;">""</span>          68.0   73.0     77.9   45.9  73.4 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>      300 1       1       1     <span style="color: #949494;">""</span>          75.2   79.6     84.2   51.4  79.5 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>      400 1       1       1     <span style="color: #949494;">""</span>          79.0   83.4     88.1   56.9  83.7 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>      500 1       1       1     <span style="color: #949494;">""</span>          81.2   85.9     90.8   60.1  87.4 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>      600 1       1       1     <span style="color: #949494;">""</span>          82.7   87.7     92.9   60.5  88.0 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>      700 1       1       1     <span style="color: #949494;">""</span>          83.8   89.1     94.5   60.8  88.9 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>      800 1       1       1     <span style="color: #949494;">""</span>          84.6   90.1     95.7   62.9  89.4 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>      900 1       1       1     <span style="color: #949494;">""</span>          85.4   90.8     96.6   62.9  91.7 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 41 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: pi_high &lt;dbl&gt;</span></span></span></code></pre></div>
<p>Input data can be obtained in a same format with
<code><a href="../reference/stanemax-methods.html">extract_obs_mod_frame()</a></code> function.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs.formatted</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stanemax-methods.html">extract_obs_mod_frame</a></span><span class="op">(</span><span class="va">fit.emax</span><span class="op">)</span></span></code></pre></div>
<p>These are particularly useful when you want to plot the estimated
Emax curve.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">resp.pred.quantile</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">exposure</span>, <span class="va">ci_med</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ci_low</span>, ymax <span class="op">=</span> <span class="va">ci_high</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">pi_low</span>, ymax <span class="op">=</span> <span class="va">pi_high</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">obs.formatted</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">response</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span></code></pre></div>
<p><img src="emaxmodel_files/figure-html/plot_with_pp-1.png" width="700"></p>
<p>Posterior draws of Emax model parameters can be extracted with
<code><a href="../reference/extract_param.html">extract_param()</a></code> function.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">posterior.fit.emax</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_param.html">extract_param</a></span><span class="op">(</span><span class="va">fit.emax</span><span class="op">)</span></span>
<span><span class="va">posterior.fit.emax</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,000 × 6</span></span></span>
<span><span class="co">#&gt;    mcmcid  emax    e0  ec50     gamma     sigma</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl[1d]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl[1d]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>      1  83.1 11.8   90.6         1      18.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>      2  98.7 -<span style="color: #BB0000;">2.84</span>  54.0         1      17.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>      3  95.0  4.01  77.4         1      13.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>      4  92.4  6.34  60.6         1      16.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>      5  91.6 10.7   65.1         1      16.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>      6 100.   4.21  72.4         1      16.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>      7  91.8  3.87  59.6         1      15.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>      8  86.2  6.69  54.2         1      20.6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>      9  97.4  2.26  59.3         1      18.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     10  85.1  8.93  54.5         1      17.5</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 990 more rows</span></span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="fix-parameter-values-in-emax-model">Fix parameter values in Emax model<a class="anchor" aria-label="anchor" href="#fix-parameter-values-in-emax-model"></a>
</h2>
<p>You can fix parameter values in Emax model for Emax, E0 and/or gamma
(Hill coefficient). See help of <code><a href="../reference/stan_emax.html">stan_emax()</a></code> for the
details. The default is to fix gamma at 1 and to estimate Emax and E0
from data.</p>
<p>Below is the example of estimating gamma from data.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">exposure.response.sample</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit.emax.sigmoidal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_emax.html">stan_emax</a></span><span class="op">(</span><span class="va">response</span> <span class="op">~</span> <span class="va">exposure</span>,</span>
<span>  data <span class="op">=</span> <span class="va">exposure.response.sample</span>,</span>
<span>  gamma.fix <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="co"># the next line is only to make the example go fast enough</span></span>
<span>  chains <span class="op">=</span> <span class="fl">2</span>, iter <span class="op">=</span> <span class="fl">1000</span>, seed <span class="op">=</span> <span class="fl">12345</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.emax.sigmoidal</span></span>
<span><span class="co">#&gt; ---- Emax model fit with rstanemax ----</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;        mean se_mean    sd  2.5%   25%   50%   75%  97.5%  n_eff Rhat</span></span>
<span><span class="co">#&gt; emax  90.02    0.58 10.32 73.46 83.11 88.70 95.63 114.76 317.23 1.01</span></span>
<span><span class="co">#&gt; e0     6.96    0.21  4.84 -3.04  3.74  7.06 10.15  16.46 528.43 1.01</span></span>
<span><span class="co">#&gt; ec50  78.62    1.72 30.22 44.50 59.56 71.99 88.88 153.71 308.57 1.00</span></span>
<span><span class="co">#&gt; gamma  1.16    0.02  0.34  0.62  0.93  1.12  1.34   1.93 444.96 1.01</span></span>
<span><span class="co">#&gt; sigma 16.81    0.08  1.69 13.99 15.56 16.61 17.84  20.53 467.62 1.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; * Use `extract_stanfit()` function to extract raw stanfit object</span></span>
<span><span class="co">#&gt; * Use `extract_param()` function to extract posterior draws of key parameters</span></span>
<span><span class="co">#&gt; * Use `plot()` function to visualize model fit</span></span>
<span><span class="co">#&gt; * Use `posterior_predict()` or `posterior_predict_quantile()` function to get</span></span>
<span><span class="co">#&gt;   raw predictions or make predictions on new data</span></span>
<span><span class="co">#&gt; * Use `extract_obs_mod_frame()` function to extract raw data </span></span>
<span><span class="co">#&gt;   in a processed format (useful for plotting)</span></span></code></pre></div>
<p>You can compare the difference of posterior predictions between two
models (in this case they are very close to each other):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposure_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">exposure.response.sample</span><span class="op">$</span><span class="va">exposure</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">exposure.response.sample</span><span class="op">$</span><span class="va">exposure</span><span class="op">)</span>,</span>
<span>  length.out <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/posterior_predict.html">posterior_predict_quantile</a></span><span class="op">(</span><span class="va">fit.emax</span>, <span class="va">exposure_pred</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"Emax"</span><span class="op">)</span></span>
<span><span class="va">pred2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/posterior_predict.html">posterior_predict_quantile</a></span><span class="op">(</span><span class="va">fit.emax.sigmoidal</span>, <span class="va">exposure_pred</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"Sigmoidal Emax"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">pred1</span>, <span class="va">pred2</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pred</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">exposure</span>, <span class="va">ci_med</span>, color <span class="op">=</span> <span class="va">model</span>, fill <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ci_low</span>, ymax <span class="op">=</span> <span class="va">ci_high</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">pi_low</span>, ymax <span class="op">=</span> <span class="va">pi_high</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.1</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">exposure.response.sample</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">exposure</span>, <span class="va">response</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="cn">NA</span>, size <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span></code></pre></div>
<p><img src="emaxmodel_files/figure-html/plot_with_gamma_fix-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="set-covariates">Set covariates<a class="anchor" aria-label="anchor" href="#set-covariates"></a>
</h2>
<p>You can specify categorical covariates for Emax, EC50, and E0. See
help of <code><a href="../reference/stan_emax.html">stan_emax()</a></code> for the details.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">exposure.response.sample.with.cov</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test.data</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">exposure.response.sample.with.cov</span>,</span>
<span>    SEX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">cov2</span> <span class="op">==</span> <span class="st">"B0"</span>, <span class="st">"MALE"</span>, <span class="st">"FEMALE"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">fit.cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_emax.html">stan_emax</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">resp</span> <span class="op">~</span> <span class="va">conc</span>, data <span class="op">=</span> <span class="va">test.data</span>,</span>
<span>  param.cov <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>emax <span class="op">=</span> <span class="st">"SEX"</span><span class="op">)</span>,</span>
<span>  <span class="co"># the next line is only to make the example go fast enough</span></span>
<span>  chains <span class="op">=</span> <span class="fl">2</span>, iter <span class="op">=</span> <span class="fl">1000</span>, seed <span class="op">=</span> <span class="fl">12345</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.cov</span></span>
<span><span class="co">#&gt; ---- Emax model fit with rstanemax ----</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                mean se_mean    sd  2.5%   25%    50%    75%  97.5%  n_eff Rhat</span></span>
<span><span class="co">#&gt; emax[FEMALE]  81.26    0.16  3.81 73.53 78.70  81.14  83.70  88.79 552.80 1.01</span></span>
<span><span class="co">#&gt; emax[MALE]    87.64    0.20  5.19 77.54 84.15  87.63  91.21  98.17 667.62 1.01</span></span>
<span><span class="co">#&gt; e0            15.20    0.09  2.30 10.40 13.72  15.22  16.69  19.66 705.42 1.01</span></span>
<span><span class="co">#&gt; ec50         107.65    0.78 21.27 67.63 93.17 106.98 121.07 151.35 742.54 1.00</span></span>
<span><span class="co">#&gt; gamma          1.00     NaN  0.00  1.00  1.00   1.00   1.00   1.00    NaN  NaN</span></span>
<span><span class="co">#&gt; sigma         10.51    0.03  1.00  8.84  9.77  10.44  11.15  12.70 871.21 1.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; * Use `extract_stanfit()` function to extract raw stanfit object</span></span>
<span><span class="co">#&gt; * Use `extract_param()` function to extract posterior draws of key parameters</span></span>
<span><span class="co">#&gt; * Use `plot()` function to visualize model fit</span></span>
<span><span class="co">#&gt; * Use `posterior_predict()` or `posterior_predict_quantile()` function to get</span></span>
<span><span class="co">#&gt;   raw predictions or make predictions on new data</span></span>
<span><span class="co">#&gt; * Use `extract_obs_mod_frame()` function to extract raw data </span></span>
<span><span class="co">#&gt;   in a processed format (useful for plotting)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit.cov</span><span class="op">)</span></span></code></pre></div>
<p><img src="emaxmodel_files/figure-html/plot_with_cov-1.png" width="576"></p>
<p>You can extract MCMC samples from raw stanfit and evaluate
differences between groups.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.cov.posterior</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/extract_param.html">extract_param</a></span><span class="op">(</span><span class="va">fit.cov</span><span class="op">)</span></span>
<span></span>
<span><span class="va">emax.posterior</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">fit.cov.posterior</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">mcmcid</span>, <span class="va">SEX</span>, <span class="va">emax</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">SEX</span>, values_from <span class="op">=</span> <span class="va">emax</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>delta <span class="op">=</span> <span class="va">FEMALE</span> <span class="op">-</span> <span class="va">MALE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/qplot.html" class="external-link">qplot</a></span><span class="op">(</span><span class="va">delta</span>, data <span class="op">=</span> <span class="va">emax.posterior</span>, bins <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"emax[FEMALE] - emax[MALE]"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: `qplot()` was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span>
<span></span>
<span><span class="co"># Credible interval of delta</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">emax.posterior</span><span class="op">$</span><span class="va">delta</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.05</span>, <span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       2.5%         5%        50%        95%      97.5% </span></span>
<span><span class="co">#&gt; -16.117172 -14.467374  -6.249869   1.593632   2.551678</span></span>
<span></span>
<span><span class="co"># Posterior probability of emax[FEMALE] &lt; emax[MALE]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">emax.posterior</span><span class="op">$</span><span class="va">delta</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">emax.posterior</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.903</span></span></code></pre></div>
<p><img src="emaxmodel_files/figure-html/compare_emax-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kenta Yoshida, Danielle Navarro.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
